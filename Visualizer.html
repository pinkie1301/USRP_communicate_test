<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS & Noise Log è¦–è¦ºåŒ–å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <h1 class="text-xl font-bold text-center">GPS & Noise Log è¦–è¦ºåŒ–å·¥å…·</h1>
        <p class="text-center text-indigo-200 text-sm mt-1">ä¸Šå‚³ CSV æª”æ¡ˆï¼Œè¦–è¦ºåŒ–æ™‚é–“è»¸æ•¸æ“š</p>
    </header>

    <main class="max-w-6xl mx-auto p-4 space-y-6">
        <!-- File Upload Section -->
        <div class="bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“ æª”æ¡ˆä¸Šå‚³</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- GPS File -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-600">
                        GPS Log (CSV)
                    </label>
                    <input type="file" id="gps-file" accept=".csv" 
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs text-gray-500">æ™‚å€æ ¡æ­£ï¼š</span>
                        <select id="gps-timezone" class="text-xs border border-gray-300 rounded px-2 py-1 bg-white">
                            <option value="-12">UTC-12</option>
                            <option value="-11">UTC-11</option>
                            <option value="-10">UTC-10</option>
                            <option value="-9">UTC-9</option>
                            <option value="-8">UTC-8</option>
                            <option value="-7">UTC-7</option>
                            <option value="-6">UTC-6</option>
                            <option value="-5">UTC-5</option>
                            <option value="-4">UTC-4</option>
                            <option value="-3">UTC-3</option>
                            <option value="-2">UTC-2</option>
                            <option value="-1">UTC-1</option>
                            <option value="0" selected>UTC+0</option>
                            <option value="1">UTC+1</option>
                            <option value="2">UTC+2</option>
                            <option value="3">UTC+3</option>
                            <option value="4">UTC+4</option>
                            <option value="5">UTC+5</option>
                            <option value="6">UTC+6</option>
                            <option value="7">UTC+7</option>
                            <option value="8">UTC+8</option>
                            <option value="9">UTC+9</option>
                            <option value="10">UTC+10</option>
                            <option value="11">UTC+11</option>
                            <option value="12">UTC+12</option>
                        </select>
                    </div>
                    <p id="gps-status" class="text-xs text-gray-400">å°šæœªé¸æ“‡æª”æ¡ˆ</p>
                </div>
                <!-- Noise File -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-600">
                        Noise Log (CSV)
                    </label>
                    <input type="file" id="noise-file" accept=".csv" 
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100 cursor-pointer">
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs text-gray-500">æ™‚å€æ ¡æ­£ï¼š</span>
                        <select id="noise-timezone" class="text-xs border border-gray-300 rounded px-2 py-1 bg-white">
                            <option value="-12">UTC-12</option>
                            <option value="-11">UTC-11</option>
                            <option value="-10">UTC-10</option>
                            <option value="-9">UTC-9</option>
                            <option value="-8">UTC-8</option>
                            <option value="-7">UTC-7</option>
                            <option value="-6">UTC-6</option>
                            <option value="-5">UTC-5</option>
                            <option value="-4">UTC-4</option>
                            <option value="-3">UTC-3</option>
                            <option value="-2">UTC-2</option>
                            <option value="-1">UTC-1</option>
                            <option value="0">UTC+0</option>
                            <option value="1">UTC+1</option>
                            <option value="2">UTC+2</option>
                            <option value="3">UTC+3</option>
                            <option value="4">UTC+4</option>
                            <option value="5">UTC+5</option>
                            <option value="6">UTC+6</option>
                            <option value="7">UTC+7</option>
                            <option value="8" selected>UTC+8</option>
                            <option value="9">UTC+9</option>
                            <option value="10">UTC+10</option>
                            <option value="11">UTC+11</option>
                            <option value="12">UTC+12</option>
                        </select>
                    </div>
                    <p id="noise-status" class="text-xs text-gray-400">å°šæœªé¸æ“‡æª”æ¡ˆ</p>
                </div>
            </div>
            <div class="mt-4 flex gap-3">
                <button id="btn-process" disabled 
                    class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-2 px-6 rounded-lg shadow transition">
                    é–‹å§‹åˆ†æ
                </button>
                <button id="btn-clear" 
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow transition">
                    æ¸…é™¤å…¨éƒ¨
                </button>
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="stats-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“Š æ•¸æ“šçµ±è¨ˆ</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-blue-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-blue-600" id="stat-gps-count">0</div>
                    <div class="text-xs text-gray-500">GPS ç´€éŒ„é»</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-orange-600" id="stat-noise-count">0</div>
                    <div class="text-xs text-gray-500">Noise ç´€éŒ„é»</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-green-600" id="stat-matched-count">0</div>
                    <div class="text-xs text-gray-500">å°é½ŠæˆåŠŸé»</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-purple-600" id="stat-match-rate">0%</div>
                    <div class="text-xs text-gray-500">å°é½Šç‡</div>
                </div>
            </div>
        </div>

        <!-- Chart 1: Noise Chart -->
        <div id="chart1-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“ˆ Noise è¨Šè™Ÿåœ–</h2>
            <div class="chart-container">
                <canvas id="noise-chart"></canvas>
            </div>
        </div>

        <!-- Chart 2: GPS Chart -->
        <div id="chart2-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ—ºï¸ GPS è»Œè·¡åœ–</h2>
            <!-- æ¼¸å±¤åœ–ä¾‹ -->
            <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-medium text-gray-600">æ™‚é–“è»¸</span>
                <span class="text-xs text-gray-500">èµ·é»</span>
                <div class="flex-grow h-4 rounded" style="background: linear-gradient(to right, #87CEEB, #9370DB, #800080);"></div>
                <span class="text-xs text-gray-500">çµ‚é»</span>
            </div>
            <div class="chart-container">
                <canvas id="gps-chart"></canvas>
            </div>
        </div>

        <!-- Chart 3: Combined Chart -->
        <div id="chart3-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ”— GPS èˆ‡ Noise å°é½Šé»</h2>
            <!-- æ¼¸å±¤åœ–ä¾‹ -->
            <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-lg">
                <span class="text-sm font-medium text-gray-600">Noise db</span>
                <span class="text-xs text-gray-500">å¼±</span>
                <div class="flex-grow h-4 rounded" style="background: linear-gradient(to right, #FFE4E1, #FF6347, #DC143C);"></div>
                <span class="text-xs text-gray-500">å¼·</span>
            </div>
            <div class="chart-container">
                <canvas id="combined-chart"></canvas>
            </div>
        </div>

        <!-- Data Preview Section -->
        <div id="preview-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“‹ å°é½Šæ•¸æ“šé è¦½ (å‰ 50 ç­†)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border">#</th>
                            <th class="p-2 border">æ™‚é–“ (UTC+8)</th>
                            <th class="p-2 border">Lat</th>
                            <th class="p-2 border">Lon</th>
                            <th class="p-2 border">Noise (dB)</th>
                        </tr>
                    </thead>
                    <tbody id="preview-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="text-center text-gray-400 text-xs py-4">
        GPS & Noise Log Visualizer v1.0
    </footer>

    <script>
        // ========== å…¨åŸŸè®Šæ•¸ ==========
        let gpsRawData = null;   // åŸå§‹ CSV è³‡æ–™
        let noiseRawData = null; // åŸå§‹ CSV è³‡æ–™
        let gpsData = [];
        let noiseData = [];
        let matchedData = [];
        
        let noiseChart = null;
        let gpsChart = null;
        let combinedChart = null;

        // ========== DOM å…ƒç´  ==========
        const els = {
            gpsFile: document.getElementById('gps-file'),
            noiseFile: document.getElementById('noise-file'),
            gpsTimezone: document.getElementById('gps-timezone'),
            noiseTimezone: document.getElementById('noise-timezone'),
            gpsStatus: document.getElementById('gps-status'),
            noiseStatus: document.getElementById('noise-status'),
            btnProcess: document.getElementById('btn-process'),
            btnClear: document.getElementById('btn-clear'),
            statsSection: document.getElementById('stats-section'),
            chart1Section: document.getElementById('chart1-section'),
            chart2Section: document.getElementById('chart2-section'),
            chart3Section: document.getElementById('chart3-section'),
            previewSection: document.getElementById('preview-section'),
        };

        // ========== å·¥å…·å‡½å¼ ==========

        // è§£æ CSV æ–‡å­—
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((h, idx) => {
                        row[h] = values[idx]?.trim();
                    });
                    data.push(row);
                }
            }
            return data;
        }

        // å°‡æ™‚é–“å­—ä¸²è½‰ç‚º Date ç‰©ä»¶ (çµ±ä¸€è½‰æ›ç‚º UTC+8)
        // sourceTimezone: ä¾†æºæ™‚å€ (ä¾‹å¦‚ 0 è¡¨ç¤º UTC+0, 8 è¡¨ç¤º UTC+8)
        function parseTimeToUTC8(timeStr, sourceTimezone = 8) {
            // ç§»é™¤å¾®ç§’éƒ¨åˆ† (åªä¿ç•™æ¯«ç§’)
            let normalizedStr = timeStr;
            const dotIndex = timeStr.lastIndexOf('.');
            if (dotIndex !== -1) {
                const fractional = timeStr.substring(dotIndex + 1);
                if (fractional.length > 3) {
                    normalizedStr = timeStr.substring(0, dotIndex + 4); // åªä¿ç•™3ä½æ¯«ç§’
                }
            }
            
            let date = new Date(normalizedStr);
            
            // è¨ˆç®—éœ€è¦èª¿æ•´çš„æ™‚å·® (ç›®æ¨™æ˜¯ UTC+8)
            const targetTimezone = 8;
            const hourDiff = targetTimezone - sourceTimezone;
            
            if (hourDiff !== 0) {
                date = new Date(date.getTime() + hourDiff * 60 * 60 * 1000);
            }
            
            return date;
        }

        // å°‡ Date è½‰ç‚ºé¡¯ç¤ºå­—ä¸²
        function formatTime(date) {
            const pad = (n, len = 2) => String(n).padStart(len, '0');
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ` +
                   `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}.${pad(date.getMilliseconds(), 3)}`;
        }

        // å–å¾—å››æ¨äº”å…¥åˆ° 0.5 ç§’çš„æ™‚é–“æˆ³ (ç”¨æ–¼å°é½Š)
        function getRoundedHalfSecondKey(date) {
            const ms = date.getTime();
            const rounded = Math.round(ms / 500) * 500; // å››æ¨äº”å…¥åˆ° 0.5 ç§’
            return rounded;
        }

        // è§£æ GPS è³‡æ–™
        function parseGpsData(rawData, timezone) {
            return rawData.map(row => {
                const time = parseTimeToUTC8(row.time_stamp, timezone);
                return {
                    time: time,
                    timeKey: getRoundedHalfSecondKey(time),
                    lat: parseFloat(row.lat),
                    lon: parseFloat(row.lon),
                    alt: parseFloat(row.alt)
                };
            }).filter(d => !isNaN(d.lat) && !isNaN(d.lon));
        }

        // è§£æ Noise è³‡æ–™
        function parseNoiseData(rawData, timezone) {
            return rawData.map(row => {
                const time = parseTimeToUTC8(row.time_stamp, timezone);
                return {
                    time: time,
                    timeKey: getRoundedHalfSecondKey(time),
                    noise_db: parseFloat(row.noise_floor_db)
                };
            }).filter(d => !isNaN(d.noise_db));
        }

        // å°é½Š GPS å’Œ Noise è³‡æ–™
        function matchData(gps, noise) {
            const matched = [];
            
            // å»ºç«‹ noise çš„ timeKey ç´¢å¼•
            const noiseMap = new Map();
            noise.forEach(n => {
                const key = n.timeKey;
                if (!noiseMap.has(key)) {
                    noiseMap.set(key, n);
                }
            });
            
            // å°æ¯å€‹ GPS é»æ‰¾å°æ‡‰çš„ noise
            gps.forEach(g => {
                const key = g.timeKey;
                if (noiseMap.has(key)) {
                    matched.push({
                        time: g.time,
                        lat: g.lat,
                        lon: g.lon,
                        noise_db: noiseMap.get(key).noise_db
                    });
                }
            });
            
            return matched;
        }

        // ========== åœ–è¡¨ç¹ªè£½ ==========

        // ç¹ªè£½ Noise æŠ˜ç·šåœ–
        function drawNoiseChart() {
            const ctx = document.getElementById('noise-chart').getContext('2d');
            
            if (noiseChart) noiseChart.destroy();
            
            // è¨ˆç®—ç´¯åŠ æ™‚é–“ (å¾ 0 é–‹å§‹ï¼Œä»¥ç§’ç‚ºå–®ä½)
            const startTime = noiseData.length > 0 ? noiseData[0].time.getTime() : 0;
            const labels = noiseData.map(d => {
                const elapsedSec = (d.time.getTime() - startTime) / 1000;
                return elapsedSec.toFixed(1);
            });
            const values = noiseData.map(d => d.noise_db);
            
            noiseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Noise Floor (dB)',
                        data: values,
                        borderColor: 'rgb(249, 115, 22)',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: (items) => `ç¶“éæ™‚é–“: ${items[0].label} ç§’`
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ç¶“éæ™‚é–“ (ç§’)' },
                            ticks: {
                                maxTicksLimit: 10,
                                maxRotation: 0
                            }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'dB' }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½ GPS æ•£é»åœ–
        function drawGpsChart() {
            const ctx = document.getElementById('gps-chart').getContext('2d');
            
            if (gpsChart) gpsChart.destroy();
            
            const points = gpsData.map(d => ({ x: d.lon, y: d.lat }));
            
            // æ ¹æ“šæ™‚é–“é †åºç”¢ç”Ÿæ¼¸å±¤é¡è‰² (æ·ºè— â†’ ç´«è‰²)
            // æ·ºè— (135, 206, 235) â†’ ä¸­ç´« (147, 112, 219) â†’ æ·±ç´« (128, 0, 128)
            const colors = gpsData.map((d, i) => {
                const ratio = gpsData.length > 1 ? i / (gpsData.length - 1) : 0;
                let r, g, b;
                if (ratio < 0.5) {
                    // æ·ºè— â†’ ä¸­ç´« (0 ~ 0.5)
                    const t = ratio * 2;
                    r = Math.round(135 * (1 - t) + 147 * t);
                    g = Math.round(206 * (1 - t) + 112 * t);
                    b = Math.round(235 * (1 - t) + 219 * t);
                } else {
                    // ä¸­ç´« â†’ æ·±ç´« (0.5 ~ 1)
                    const t = (ratio - 0.5) * 2;
                    r = Math.round(147 * (1 - t) + 128 * t);
                    g = Math.round(112 * (1 - t) + 0 * t);
                    b = Math.round(219 * (1 - t) + 128 * t);
                }
                return `rgba(${r}, ${g}, ${b}, 0.85)`;
            });
            
            gpsChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'GPS è»Œè·¡',
                        data: points,
                        backgroundColor: colors,
                        borderColor: colors,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const idx = ctx.dataIndex;
                                    const startTime = gpsData.length > 0 ? gpsData[0].time.getTime() : 0;
                                    const elapsedSec = (gpsData[idx].time.getTime() - startTime) / 1000;
                                    return `t=${elapsedSec.toFixed(1)}s - Lat: ${ctx.parsed.y.toFixed(6)}, Lon: ${ctx.parsed.x.toFixed(6)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ç¶“åº¦ (Longitude)' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'ç·¯åº¦ (Latitude)' }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½åˆä½µåœ– (å°é½ŠæˆåŠŸé»ï¼Œæ¼¸å±¤é¡è‰²)
        function drawCombinedChart() {
            const ctx = document.getElementById('combined-chart').getContext('2d');
            
            if (combinedChart) combinedChart.destroy();
            
            const matchedPoints = matchedData.map(d => ({ x: d.lon, y: d.lat }));
            
            // æ ¹æ“š noise dB å¼·åº¦ç”¢ç”Ÿæ¼¸å±¤é¡è‰²
            // dB è¶Šé«˜ (è¶Šæ¥è¿‘ 0) = è¶Šå¼· = æ©˜ç´…è‰²
            // dB è¶Šä½ (è¶Šè² ) = è¶Šå¼± = æ·ºè‰²
            const noiseValues = matchedData.map(d => d.noise_db);
            const minNoise = Math.min(...noiseValues);
            const maxNoise = Math.max(...noiseValues);
            const noiseRange = maxNoise - minNoise || 1; // é¿å…é™¤ä»¥ 0
            
            const colors = matchedData.map((d) => {
                // æ­£è¦åŒ–åˆ° 0~1 (0=æœ€å¼±, 1=æœ€å¼·)
                const ratio = (d.noise_db - minNoise) / noiseRange;
                
                // æ·ºç²‰ç´… (255, 228, 225) â†’ ç•ªèŒ„ç´… (255, 99, 71) â†’ ç´…è‰² (220, 20, 60)
                let r, g, b;
                if (ratio < 0.5) {
                    // æ·ºç²‰ç´… â†’ ç•ªèŒ„ç´… (0 ~ 0.5)
                    const t = ratio * 2;
                    r = 255;
                    g = Math.round(228 * (1 - t) + 99 * t);
                    b = Math.round(225 * (1 - t) + 71 * t);
                } else {
                    // ç•ªèŒ„ç´… â†’ æ·±ç´… (0.5 ~ 1)
                    const t = (ratio - 0.5) * 2;
                    r = Math.round(255 * (1 - t) + 220 * t);
                    g = Math.round(99 * (1 - t) + 20 * t);
                    b = Math.round(71 * (1 - t) + 60 * t);
                }
                return `rgba(${r}, ${g}, ${b}, 0.85)`;
            });
            
            combinedChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'å°é½ŠæˆåŠŸé»',
                        data: matchedPoints,
                        backgroundColor: colors,
                        borderColor: colors,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const idx = ctx.dataIndex;
                                    const startTime = matchedData.length > 0 ? matchedData[0].time.getTime() : 0;
                                    const elapsedSec = (matchedData[idx].time.getTime() - startTime) / 1000;
                                    const noiseDb = matchedData[idx].noise_db.toFixed(2);
                                    return `t=${elapsedSec.toFixed(1)}s | Noise: ${noiseDb}dB | Lat: ${ctx.parsed.y.toFixed(6)}, Lon: ${ctx.parsed.x.toFixed(6)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ç¶“åº¦ (Longitude)' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'ç·¯åº¦ (Latitude)' }
                        }
                    }
                }
            });
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            document.getElementById('stat-gps-count').textContent = gpsData.length;
            document.getElementById('stat-noise-count').textContent = noiseData.length;
            document.getElementById('stat-matched-count').textContent = matchedData.length;
            
            const rate = gpsData.length > 0 ? 
                ((matchedData.length / gpsData.length) * 100).toFixed(1) : 0;
            document.getElementById('stat-match-rate').textContent = rate + '%';
        }

        // æ›´æ–°é è¦½è¡¨æ ¼
        function updatePreview() {
            const tbody = document.getElementById('preview-body');
            tbody.innerHTML = '';
            
            const previewData = matchedData.slice(0, 50);
            previewData.forEach((d, i) => {
                const tr = document.createElement('tr');
                tr.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                tr.innerHTML = `
                    <td class="p-2 border">${i + 1}</td>
                    <td class="p-2 border font-mono text-xs">${formatTime(d.time)}</td>
                    <td class="p-2 border font-mono">${d.lat.toFixed(7)}</td>
                    <td class="p-2 border font-mono">${d.lon.toFixed(7)}</td>
                    <td class="p-2 border font-mono">${d.noise_db.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (previewData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">ç„¡å°é½Šæ•¸æ“š</td></tr>';
            }
        }

        // ========== ä¸»è¦è™•ç†é‚è¼¯ ==========

        function processFiles() {
            // å–å¾—é¸æ“‡çš„æ™‚å€
            const gpsTimezone = parseInt(els.gpsTimezone.value);
            const noiseTimezone = parseInt(els.noiseTimezone.value);
            
            // æ ¹æ“šæ™‚å€è§£æè³‡æ–™
            gpsData = parseGpsData(gpsRawData, gpsTimezone);
            noiseData = parseNoiseData(noiseRawData, noiseTimezone);
            
            // é¡¯ç¤ºæ‰€æœ‰å€å¡Š
            els.statsSection.classList.remove('hidden');
            els.chart1Section.classList.remove('hidden');
            els.chart2Section.classList.remove('hidden');
            els.chart3Section.classList.remove('hidden');
            els.previewSection.classList.remove('hidden');
            
            // å°é½Šè³‡æ–™
            matchedData = matchData(gpsData, noiseData);
            
            // æ›´æ–° UI
            updateStats();
            drawNoiseChart();
            drawGpsChart();
            drawCombinedChart();
            updatePreview();
        }

        function clearAll() {
            gpsRawData = null;
            noiseRawData = null;
            gpsData = [];
            noiseData = [];
            matchedData = [];
            
            els.gpsFile.value = '';
            els.noiseFile.value = '';
            els.gpsTimezone.value = '0';
            els.noiseTimezone.value = '8';
            els.gpsStatus.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
            els.gpsStatus.className = 'text-xs text-gray-400';
            els.noiseStatus.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
            els.noiseStatus.className = 'text-xs text-gray-400';
            els.btnProcess.disabled = true;
            
            els.statsSection.classList.add('hidden');
            els.chart1Section.classList.add('hidden');
            els.chart2Section.classList.add('hidden');
            els.chart3Section.classList.add('hidden');
            els.previewSection.classList.add('hidden');
            
            if (noiseChart) { noiseChart.destroy(); noiseChart = null; }
            if (gpsChart) { gpsChart.destroy(); gpsChart = null; }
            if (combinedChart) { combinedChart.destroy(); combinedChart = null; }
        }

        function checkFilesReady() {
            els.btnProcess.disabled = !(gpsRawData && noiseRawData);
        }

        // ========== äº‹ä»¶ç¶å®š ==========

        els.gpsFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                gpsRawData = parseCSV(text);
                els.gpsStatus.textContent = `âœ“ å·²è¼‰å…¥ ${gpsRawData.length} ç­† GPS è³‡æ–™ (å¾…åˆ†æ)`;
                els.gpsStatus.className = 'text-xs text-green-600';
            } catch (err) {
                els.gpsStatus.textContent = 'âœ— æª”æ¡ˆè§£æå¤±æ•—';
                els.gpsStatus.className = 'text-xs text-red-600';
                gpsRawData = null;
            }
            checkFilesReady();
        });

        els.noiseFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                noiseRawData = parseCSV(text);
                els.noiseStatus.textContent = `âœ“ å·²è¼‰å…¥ ${noiseRawData.length} ç­† Noise è³‡æ–™ (å¾…åˆ†æ)`;
                els.noiseStatus.className = 'text-xs text-green-600';
            } catch (err) {
                els.noiseStatus.textContent = 'âœ— æª”æ¡ˆè§£æå¤±æ•—';
                els.noiseStatus.className = 'text-xs text-red-600';
                noiseRawData = null;
            }
            checkFilesReady();
        });

        els.btnProcess.addEventListener('click', processFiles);
        els.btnClear.addEventListener('click', clearAll);

    </script>
</body>
</html>
