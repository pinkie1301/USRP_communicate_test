<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS & Noise Log è¦–è¦ºåŒ–å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <h1 class="text-xl font-bold text-center">GPS & Noise Log è¦–è¦ºåŒ–å·¥å…·</h1>
        <p class="text-center text-indigo-200 text-sm mt-1">ä¸Šå‚³ CSV æª”æ¡ˆï¼Œè¦–è¦ºåŒ–æ™‚é–“è»¸æ•¸æ“š</p>
    </header>

    <main class="max-w-6xl mx-auto p-4 space-y-6">
        <!-- File Upload Section -->
        <div class="bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“ æª”æ¡ˆä¸Šå‚³</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- GPS File -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-600">
                        GPS Log (CSV) - æ™‚å€ UTC+0
                    </label>
                    <input type="file" id="gps-file" accept=".csv" 
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <p id="gps-status" class="text-xs text-gray-400">å°šæœªé¸æ“‡æª”æ¡ˆ</p>
                </div>
                <!-- Noise File -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-600">
                        Noise Log (CSV) - æ™‚å€ UTC+8
                    </label>
                    <input type="file" id="noise-file" accept=".csv" 
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100 cursor-pointer">
                    <p id="noise-status" class="text-xs text-gray-400">å°šæœªé¸æ“‡æª”æ¡ˆ</p>
                </div>
            </div>
            <div class="mt-4 flex gap-3">
                <button id="btn-process" disabled 
                    class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-2 px-6 rounded-lg shadow transition">
                    é–‹å§‹åˆ†æ
                </button>
                <button id="btn-clear" 
                    class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow transition">
                    æ¸…é™¤å…¨éƒ¨
                </button>
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="stats-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“Š æ•¸æ“šçµ±è¨ˆ</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-blue-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-blue-600" id="stat-gps-count">0</div>
                    <div class="text-xs text-gray-500">GPS ç´€éŒ„é»</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-orange-600" id="stat-noise-count">0</div>
                    <div class="text-xs text-gray-500">Noise ç´€éŒ„é»</div>
                </div>
                <div class="bg-green-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-green-600" id="stat-matched-count">0</div>
                    <div class="text-xs text-gray-500">å°é½ŠæˆåŠŸé»</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-3">
                    <div class="text-2xl font-bold text-purple-600" id="stat-match-rate">0%</div>
                    <div class="text-xs text-gray-500">å°é½Šç‡</div>
                </div>
            </div>
        </div>

        <!-- Chart 1: Noise Chart -->
        <div id="chart1-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“ˆ Noise è¨Šè™Ÿåœ– (æŠ˜ç·šåœ–)</h2>
            <div class="chart-container">
                <canvas id="noise-chart"></canvas>
            </div>
        </div>

        <!-- Chart 2: GPS Chart -->
        <div id="chart2-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ—ºï¸ GPS è»Œè·¡åœ– (äºŒç¶­é»åœ–)</h2>
            <div class="chart-container">
                <canvas id="gps-chart"></canvas>
            </div>
        </div>

        <!-- Chart 3: Combined Chart -->
        <div id="chart3-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ”— Noise èˆ‡ GPS ç–Šåœ–</h2>
            <!-- Toggle Controls -->
            <div class="flex flex-wrap gap-4 mb-4 p-3 bg-gray-50 rounded-lg">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="toggle-gps" checked class="w-4 h-4 text-blue-600 rounded">
                    <span class="text-sm font-medium text-blue-600">ğŸ”µ GPS å…¨éƒ¨é»</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="toggle-noise" checked class="w-4 h-4 text-orange-600 rounded">
                    <span class="text-sm font-medium text-orange-600">ğŸŸ  Noise å…¨éƒ¨é»</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="toggle-matched" checked class="w-4 h-4 text-green-600 rounded">
                    <span class="text-sm font-medium text-green-600">ğŸŸ¢ å°é½ŠæˆåŠŸé»</span>
                </label>
            </div>
            <div class="chart-container">
                <canvas id="combined-chart"></canvas>
            </div>
        </div>

        <!-- Data Preview Section -->
        <div id="preview-section" class="hidden bg-white rounded-xl shadow p-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“‹ å°é½Šæ•¸æ“šé è¦½ (å‰ 50 ç­†)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border">#</th>
                            <th class="p-2 border">æ™‚é–“ (UTC+8)</th>
                            <th class="p-2 border">Lat</th>
                            <th class="p-2 border">Lon</th>
                            <th class="p-2 border">Noise (dB)</th>
                        </tr>
                    </thead>
                    <tbody id="preview-body"></tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="text-center text-gray-400 text-xs py-4">
        GPS & Noise Log Visualizer v1.0
    </footer>

    <script>
        // ========== å…¨åŸŸè®Šæ•¸ ==========
        let gpsData = [];
        let noiseData = [];
        let matchedData = [];
        
        let noiseChart = null;
        let gpsChart = null;
        let combinedChart = null;

        // ========== DOM å…ƒç´  ==========
        const els = {
            gpsFile: document.getElementById('gps-file'),
            noiseFile: document.getElementById('noise-file'),
            gpsStatus: document.getElementById('gps-status'),
            noiseStatus: document.getElementById('noise-status'),
            btnProcess: document.getElementById('btn-process'),
            btnClear: document.getElementById('btn-clear'),
            statsSection: document.getElementById('stats-section'),
            chart1Section: document.getElementById('chart1-section'),
            chart2Section: document.getElementById('chart2-section'),
            chart3Section: document.getElementById('chart3-section'),
            previewSection: document.getElementById('preview-section'),
            toggleGps: document.getElementById('toggle-gps'),
            toggleNoise: document.getElementById('toggle-noise'),
            toggleMatched: document.getElementById('toggle-matched'),
        };

        // ========== å·¥å…·å‡½å¼ ==========

        // è§£æ CSV æ–‡å­—
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((h, idx) => {
                        row[h] = values[idx]?.trim();
                    });
                    data.push(row);
                }
            }
            return data;
        }

        // å°‡æ™‚é–“å­—ä¸²è½‰ç‚º Date ç‰©ä»¶ (å·²è½‰æ›ç‚º UTC+8)
        function parseTimeToUTC8(timeStr, isUTC0 = false) {
            // ç§»é™¤å¾®ç§’éƒ¨åˆ† (åªä¿ç•™æ¯«ç§’)
            let normalizedStr = timeStr;
            const dotIndex = timeStr.lastIndexOf('.');
            if (dotIndex !== -1) {
                const fractional = timeStr.substring(dotIndex + 1);
                if (fractional.length > 3) {
                    normalizedStr = timeStr.substring(0, dotIndex + 4); // åªä¿ç•™3ä½æ¯«ç§’
                }
            }
            
            let date = new Date(normalizedStr);
            
            // å¦‚æœæ˜¯ UTC+0ï¼ŒåŠ ä¸Š 8 å°æ™‚è½‰ç‚º UTC+8
            if (isUTC0) {
                date = new Date(date.getTime() + 8 * 60 * 60 * 1000);
            }
            
            return date;
        }

        // å°‡ Date è½‰ç‚ºé¡¯ç¤ºå­—ä¸²
        function formatTime(date) {
            const pad = (n, len = 2) => String(n).padStart(len, '0');
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ` +
                   `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}.${pad(date.getMilliseconds(), 3)}`;
        }

        // å–å¾—å››æ¨äº”å…¥åˆ° 0.5 ç§’çš„æ™‚é–“æˆ³ (ç”¨æ–¼å°é½Š)
        function getRoundedHalfSecondKey(date) {
            const ms = date.getTime();
            const rounded = Math.round(ms / 500) * 500; // å››æ¨äº”å…¥åˆ° 0.5 ç§’
            return rounded;
        }

        // è§£æ GPS è³‡æ–™
        function parseGpsData(rawData) {
            return rawData.map(row => {
                const time = parseTimeToUTC8(row.time_stamp, true); // GPS æ˜¯ UTC+0ï¼Œéœ€è½‰æ›
                return {
                    time: time,
                    timeKey: getRoundedHalfSecondKey(time),
                    lat: parseFloat(row.lat),
                    lon: parseFloat(row.lon),
                    alt: parseFloat(row.alt)
                };
            }).filter(d => !isNaN(d.lat) && !isNaN(d.lon));
        }

        // è§£æ Noise è³‡æ–™
        function parseNoiseData(rawData) {
            return rawData.map(row => {
                const time = parseTimeToUTC8(row.time_stamp, false); // Noise å·²æ˜¯ UTC+8
                return {
                    time: time,
                    timeKey: getRoundedHalfSecondKey(time),
                    noise_db: parseFloat(row.noise_floor_db)
                };
            }).filter(d => !isNaN(d.noise_db));
        }

        // å°é½Š GPS å’Œ Noise è³‡æ–™
        function matchData(gps, noise) {
            const matched = [];
            
            // å»ºç«‹ noise çš„ timeKey ç´¢å¼•
            const noiseMap = new Map();
            noise.forEach(n => {
                const key = n.timeKey;
                if (!noiseMap.has(key)) {
                    noiseMap.set(key, n);
                }
            });
            
            // å°æ¯å€‹ GPS é»æ‰¾å°æ‡‰çš„ noise
            gps.forEach(g => {
                const key = g.timeKey;
                if (noiseMap.has(key)) {
                    matched.push({
                        time: g.time,
                        lat: g.lat,
                        lon: g.lon,
                        noise_db: noiseMap.get(key).noise_db
                    });
                }
            });
            
            return matched;
        }

        // ========== åœ–è¡¨ç¹ªè£½ ==========

        // ç¹ªè£½ Noise æŠ˜ç·šåœ–
        function drawNoiseChart() {
            const ctx = document.getElementById('noise-chart').getContext('2d');
            
            if (noiseChart) noiseChart.destroy();
            
            const labels = noiseData.map(d => formatTime(d.time));
            const values = noiseData.map(d => d.noise_db);
            
            noiseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Noise Floor (dB)',
                        data: values,
                        borderColor: 'rgb(249, 115, 22)',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'æ™‚é–“ (UTC+8)' },
                            ticks: {
                                maxTicksLimit: 10,
                                maxRotation: 45
                            }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'dB' }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½ GPS æ•£é»åœ–
        function drawGpsChart() {
            const ctx = document.getElementById('gps-chart').getContext('2d');
            
            if (gpsChart) gpsChart.destroy();
            
            const points = gpsData.map(d => ({ x: d.lon, y: d.lat }));
            
            gpsChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'GPS è»Œè·¡',
                        data: points,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Lat: ${ctx.parsed.y.toFixed(6)}, Lon: ${ctx.parsed.x.toFixed(6)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ç¶“åº¦ (Longitude)' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'ç·¯åº¦ (Latitude)' }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½åˆä½µåœ–
        function drawCombinedChart() {
            const ctx = document.getElementById('combined-chart').getContext('2d');
            
            if (combinedChart) combinedChart.destroy();
            
            // ç‚º noise è³‡æ–™ç”¢ç”Ÿè™›æ“¬åº§æ¨™ (ä½¿ç”¨ç›¸åŒ timeKey å°æ‡‰çš„ GPS åº§æ¨™ï¼Œè‹¥ç„¡å‰‡è·³é)
            // é€™è£¡æˆ‘å€‘ç”¨ä¸€å€‹ä¸åŒçš„æ–¹å¼ï¼šnoise é»ä½¿ç”¨å°é½Šåˆ°çš„ GPS åº§æ¨™
            const gpsPoints = gpsData.map(d => ({ x: d.lon, y: d.lat }));
            
            // Noise é»ï¼šæ‰¾æœ€è¿‘çš„ GPS åº§æ¨™
            const gpsTimeMap = new Map();
            gpsData.forEach(g => {
                gpsTimeMap.set(g.timeKey, g);
            });
            
            const noisePoints = [];
            noiseData.forEach(n => {
                if (gpsTimeMap.has(n.timeKey)) {
                    const g = gpsTimeMap.get(n.timeKey);
                    noisePoints.push({ x: g.lon, y: g.lat });
                }
            });
            
            const matchedPoints = matchedData.map(d => ({ x: d.lon, y: d.lat }));
            
            combinedChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'GPS å…¨éƒ¨é»',
                            data: gpsPoints,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgb(59, 130, 246)',
                            pointRadius: 4,
                            hidden: !els.toggleGps.checked
                        },
                        {
                            label: 'Noise å°æ‡‰é»',
                            data: noisePoints,
                            backgroundColor: 'rgba(249, 115, 22, 0.5)',
                            borderColor: 'rgb(249, 115, 22)',
                            pointRadius: 4,
                            hidden: !els.toggleNoise.checked
                        },
                        {
                            label: 'å°é½ŠæˆåŠŸé»',
                            data: matchedPoints,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderColor: 'rgb(34, 197, 94)',
                            pointRadius: 6,
                            hidden: !els.toggleMatched.checked
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: Lat ${ctx.parsed.y.toFixed(6)}, Lon ${ctx.parsed.x.toFixed(6)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'ç¶“åº¦ (Longitude)' }
                        },
                        y: {
                            display: true,
                            title: { display: true, text: 'ç·¯åº¦ (Latitude)' }
                        }
                    }
                }
            });
        }

        // æ›´æ–°åˆä½µåœ–çš„é¡¯ç¤º/éš±è—
        function updateCombinedChartVisibility() {
            if (!combinedChart) return;
            combinedChart.data.datasets[0].hidden = !els.toggleGps.checked;
            combinedChart.data.datasets[1].hidden = !els.toggleNoise.checked;
            combinedChart.data.datasets[2].hidden = !els.toggleMatched.checked;
            combinedChart.update();
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            document.getElementById('stat-gps-count').textContent = gpsData.length;
            document.getElementById('stat-noise-count').textContent = noiseData.length;
            document.getElementById('stat-matched-count').textContent = matchedData.length;
            
            const rate = gpsData.length > 0 ? 
                ((matchedData.length / gpsData.length) * 100).toFixed(1) : 0;
            document.getElementById('stat-match-rate').textContent = rate + '%';
        }

        // æ›´æ–°é è¦½è¡¨æ ¼
        function updatePreview() {
            const tbody = document.getElementById('preview-body');
            tbody.innerHTML = '';
            
            const previewData = matchedData.slice(0, 50);
            previewData.forEach((d, i) => {
                const tr = document.createElement('tr');
                tr.className = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                tr.innerHTML = `
                    <td class="p-2 border">${i + 1}</td>
                    <td class="p-2 border font-mono text-xs">${formatTime(d.time)}</td>
                    <td class="p-2 border font-mono">${d.lat.toFixed(7)}</td>
                    <td class="p-2 border font-mono">${d.lon.toFixed(7)}</td>
                    <td class="p-2 border font-mono">${d.noise_db.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (previewData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">ç„¡å°é½Šæ•¸æ“š</td></tr>';
            }
        }

        // ========== ä¸»è¦è™•ç†é‚è¼¯ ==========

        function processFiles() {
            // é¡¯ç¤ºæ‰€æœ‰å€å¡Š
            els.statsSection.classList.remove('hidden');
            els.chart1Section.classList.remove('hidden');
            els.chart2Section.classList.remove('hidden');
            els.chart3Section.classList.remove('hidden');
            els.previewSection.classList.remove('hidden');
            
            // å°é½Šè³‡æ–™
            matchedData = matchData(gpsData, noiseData);
            
            // æ›´æ–° UI
            updateStats();
            drawNoiseChart();
            drawGpsChart();
            drawCombinedChart();
            updatePreview();
        }

        function clearAll() {
            gpsData = [];
            noiseData = [];
            matchedData = [];
            
            els.gpsFile.value = '';
            els.noiseFile.value = '';
            els.gpsStatus.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
            els.noiseStatus.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ';
            els.btnProcess.disabled = true;
            
            els.statsSection.classList.add('hidden');
            els.chart1Section.classList.add('hidden');
            els.chart2Section.classList.add('hidden');
            els.chart3Section.classList.add('hidden');
            els.previewSection.classList.add('hidden');
            
            if (noiseChart) { noiseChart.destroy(); noiseChart = null; }
            if (gpsChart) { gpsChart.destroy(); gpsChart = null; }
            if (combinedChart) { combinedChart.destroy(); combinedChart = null; }
        }

        function checkFilesReady() {
            els.btnProcess.disabled = !(gpsData.length > 0 && noiseData.length > 0);
        }

        // ========== äº‹ä»¶ç¶å®š ==========

        els.gpsFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const raw = parseCSV(text);
                gpsData = parseGpsData(raw);
                els.gpsStatus.textContent = `âœ“ å·²è¼‰å…¥ ${gpsData.length} ç­† GPS è³‡æ–™`;
                els.gpsStatus.className = 'text-xs text-green-600';
            } catch (err) {
                els.gpsStatus.textContent = 'âœ— æª”æ¡ˆè§£æå¤±æ•—';
                els.gpsStatus.className = 'text-xs text-red-600';
                gpsData = [];
            }
            checkFilesReady();
        });

        els.noiseFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const raw = parseCSV(text);
                noiseData = parseNoiseData(raw);
                els.noiseStatus.textContent = `âœ“ å·²è¼‰å…¥ ${noiseData.length} ç­† Noise è³‡æ–™`;
                els.noiseStatus.className = 'text-xs text-green-600';
            } catch (err) {
                els.noiseStatus.textContent = 'âœ— æª”æ¡ˆè§£æå¤±æ•—';
                els.noiseStatus.className = 'text-xs text-red-600';
                noiseData = [];
            }
            checkFilesReady();
        });

        els.btnProcess.addEventListener('click', processFiles);
        els.btnClear.addEventListener('click', clearAll);

        // åˆä½µåœ–åˆ‡æ›äº‹ä»¶
        els.toggleGps.addEventListener('change', updateCombinedChartVisibility);
        els.toggleNoise.addEventListener('change', updateCombinedChartVisibility);
        els.toggleMatched.addEventListener('change', updateCombinedChartVisibility);

    </script>
</body>
</html>
